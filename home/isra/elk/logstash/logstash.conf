input {
  file {
    path => "/logs/*.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    tags => ["csv"]
  }
  file {
    path => "/logs/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    tags => ["json"]
  }
  file {
    path => "/logs/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    tags => ["log"]
  }
  file {
    path => "/logs/*.txt"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    tags => ["txt"]
  }
}

filter {
  # Parse CSV files
  if "csv" in [tags] {
    # Drop header line
    if [message] =~ /^timestamp,/ {
      drop { }
    }
    
    csv {
      separator => ","
      columns => ["timestamp","level","event","customer_id","name","email","country","registration_date","total_orders","lifetime_value"]
    }
    
    mutate {
      convert => {
        "total_orders" => "integer"
        "lifetime_value" => "float"
      }
      strip => ["timestamp", "level", "event", "customer_id", "name", "email", "country"]
    }
    
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }
  }
  
  # Parse JSON files
  else if "json" in [tags] {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
    
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }
  }
  
  # Parse LOG files (key=value format)
  else if "log" in [tags] {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:level} %{WORD:event} %{GREEDYDATA:details}"
      }
    }
    
    if [details] {
      kv {
        source => "details"
        field_split => " "
        value_split => "="
      }
    }
    
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }
  }
  
  # Parse TXT files (same as LOG)
  else if "txt" in [tags] {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:level} %{WORD:event} %{GREEDYDATA:details}"
      }
    }
    
    if [details] {
      kv {
        source => "details"
        field_split => " "
        value_split => "="
      }
    }
    
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }
  }
  
  # Add tags based on level
  if [level] =~ /(?i)ERROR|CRITICAL/ {
    mutate {
      add_tag => ["error"]
    }
  }
  
  if [level] =~ /(?i)WARNING|ALERT/ {
    mutate {
      add_tag => ["warning"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "ecommerce-logs"
  }
  stdout { codec => rubydebug }
}
